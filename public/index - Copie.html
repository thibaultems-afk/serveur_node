<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Envoyer fiche client - Kleos uploader</title>
  <link rel="stylesheet" href="style4.css">
  <!--<style>
    body { font-family: system-ui, Arial; padding: 20px; max-width: 720px; margin: auto; }
    label { display:block; margin-top:10px; }
    input, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .small { font-size:0.9em; color:#555; }
    button { margin-top:12px; padding:10px 16px; }
    .result { margin-top:12px; white-space:pre-wrap; background:#f4f4f4; padding:10px; border-radius:6px; }
	.hidden { display: none; }
  </style>-->
</head>
<body>
  <header>
    Création d'un contact
  </header>

  <form id="clientForm" enctype="multipart/form-data">
   
   <!-- Informations du contact -->
    <label class="section-title">Informations du contact</label>
	<label>Type de contact
      <select name="contactType" id="contactTypeSelect" required>
        <option value="">Choisir...</option>
      </select>
    </label>
	
	<label id="labelgender" class="hidden">Genre
	  <select name="gender" id="genderSelect" required>
		<option value="">Choisir...</option>
	  </select>
	</label>	

	<!-- Nom / Société -->
	<label id="labelNom">Nom <input name="nom" id="inputNom" required placeholder="Ex: Dupont" value="Dupont"/></label>

    <!-- Prénom -->
    <label id="labelPrenom" class="hidden">Prénom <input name="prenom" id="inputPrenom" placeholder="Ex: Jean" value="Bertrand"/></label>

    <!-- Champs spécifiques personne morale -->
    <label id="labelFormeJuridique" class="hidden">Forme juridique <input name="formeJuridique" placeholder="Ex: SARL, SAS, SA" value="SA"/></label>
    <label id="labelTva" class="hidden">Numéro de TVA <input name="numintra" placeholder="Ex: FR12345678901" value="FR "/></label>
    <label id="labelSiret" class="hidden">Numéro de SIRET <input name="numeroSIRET" placeholder="Ex: 123 456 789 00012" value="123 456 789 00012"/></label>

    <!-- Email -->
    <label>Email <input name="email" type="email" placeholder="Ex: jean.dupont@email.com" value="jean.dupont@gmail.com"/></label>
	<label>Téléphone <input name="phone" type="phone" placeholder="Ex: 06.01.02.03.04" value="06.01.02.03.04"/></label>
    <label class="section-title">Adresse</label>
	<label>Rue <input name="street" required placeholder="Ex: Rue de Test 1" value="Rue de Test 1"/></label>
    <label>Ville <input name="city" required placeholder="Ex: Bruxelles"  value="PARIS"/></label>
    <label>Code postal <input name="postalCode" required placeholder="Ex: 75001" value="75001"/></label>
    <label>Pays
      <select name="country" id="countrycodesSelect" required>
        <option value="">Choisir...</option>
      </select>
    </label> 
	<!--<label>Pays <input name="country" required placeholder="Ex: FRANCE"/></label>-->

    <!-- Informations du dossier -->
    <label class="section-title">Dossier</label>
	<label>Type de dossier
      <select name="typeId" id="caseTypesSelect" required>
        <option value="">Chargement...</option>
      </select>
    </label>

    <label>Documents à joindre <input type="file" name="documents" multiple/></label>
    <button type="submit">Envoyer</button>
  </form>

  <div class="small">Important: les appels réels se font via le serveur (sécurité).</div>
  <div class="result" id="result"></div>

  <script>
    // Charger les types de contact (N=Natural, L=Legal)
    function loadContactTypes() {
      const sel = document.getElementById('contactTypeSelect');
      sel.innerHTML = '<option value="">Choisir...</option>';
      const types = [
        { value: 'N', label: 'Personne physique' },
        { value: 'L', label: 'Personne morale' }
      ];
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.value;
        opt.textContent = t.label;
        sel.appendChild(opt);
      });
    }
	
	// Charger les genres (H/F/Autre)
	function loadGenders() {
	  const sel = document.getElementById('genderSelect');
	  sel.innerHTML = '<option value="">Choisir...</option>';
	  const genders = [
		{ value: 'M', label: 'Monsieur' },
		{ value: 'F', label: 'Madame' },
		{ value: 'U', label: 'Autre' }
	  ];
	  genders.forEach(g => {
		const opt = document.createElement('option');
		opt.value = g.value;
		opt.textContent = g.label;
		sel.appendChild(opt);
	  });
	}

	document.getElementById('contactTypeSelect').addEventListener('change', function() {
	  const isMoral = this.value === 'L'; // L = Personne morale (Legal), N = Personne physique (Natural)

	  // Prénom
	  const prenomLabel = document.getElementById('labelPrenom');
	  prenomLabel.classList.toggle('hidden', isMoral); 
	  document.getElementById('inputPrenom').required = !isMoral;

	  // Genre
	  const genderLabel = document.getElementById('labelgender');
	  genderLabel.classList.toggle('hidden', isMoral); 
	  document.getElementById('genderSelect').required = !isMoral;

	  // Nom / Société
	  const labelNom = document.getElementById('labelNom');
	  const inputNom = document.getElementById('inputNom');
	  labelNom.childNodes[0].textContent = isMoral ? "Nom de la société " : "Nom ";
	  inputNom.placeholder = isMoral ? "Ex: Nom de l'entreprise" : "Ex: Dupont";
	  inputNom.value = isMoral ? "Myriam et associé" : "Dupont";

	  // Champs spécifiques personne morale
	  document.getElementById('labelFormeJuridique').classList.toggle('hidden', !isMoral);
	  document.getElementById('labelTva').classList.toggle('hidden', !isMoral);
	  document.getElementById('labelSiret').classList.toggle('hidden', !isMoral);
	});
	
	// Charger les pays dans le select
	async function loadCountries() {
  const sel = document.getElementById('countrycodesSelect');
  sel.innerHTML = '<option value="">Choisir...</option>';

  try {
    const res = await fetch('/api/countries');
    const countries = await res.json();
    
    countries.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.code;
      opt.textContent = `${c.code} - ${c.name}`;
      sel.appendChild(opt);
    });
  } catch (err) {
    sel.innerHTML = '<option value="">Erreur de chargement</option>';
    console.error(err);
  }
}

    // Charger les types de dossier depuis le serveur
    async function loadCaseTypes() {
      const sel = document.getElementById('caseTypesSelect');
      try {
        const r = await fetch('/api/case-types');
        const json = await r.json();
        sel.innerHTML = '';
        if (Array.isArray(json) && json.length) {
          json.forEach(ct => {
            const opt = document.createElement('option');
            opt.value = ct.id; // correspond à caseTypeID attendu par Kleos
            opt.textContent = ct.name;
            sel.appendChild(opt);
          });
        } else {
          sel.innerHTML = '<option value="">Aucun type disponible</option>';
        }
      } catch (e) {
        sel.innerHTML = '<option value="">Erreur de chargement</option>';
      }
    }
	
    loadContactTypes();
	loadGenders();
	loadCountries();
	loadCaseTypes();

    // Soumission du formulaire
    document.getElementById('clientForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const fd = new FormData(form);

      const resEl = document.getElementById('result');
      resEl.textContent = 'Envoi en cours...';

      try {
        const r = await fetch('/api/submit-case', { method: 'POST', body: fd });
        const json = await r.json();
        resEl.textContent = JSON.stringify(json, null, 2);
      } catch (err) {
        resEl.textContent = 'Erreur: ' + err.message;
      }
    });
  </script>
</body>
</html>
